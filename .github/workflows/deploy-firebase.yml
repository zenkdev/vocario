name: Build and Deploy to Firebase

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Build web app
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}
        run: npm run build -- --filter=./apps/web

      - name: Test
        run: npm test

      # Required setup:
      # You need to add a GitHub secret for Firebase authentication:
      # 1. Get your Firebase service account key:
      #    - Go to Firebase Console
      #    - Select your project (vocario)
      #    - Go to Project Settings → Service Accounts
      #    - Click "Generate new private key"
      #    - Download the JSON file
      # 2. Add the secret to GitHub:
      #    - Go to your GitHub repository
      #    - Navigate to Settings → Secrets and variables → Actions
      #    - Click "New repository secret"
      #    - Name: FIREBASE_SERVICE_ACCOUNT
      #    - Value: Paste the entire contents of the downloaded JSON file
      #    - Click "Add secret"

      - name: Deploy to Firebase
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: vocario
          channelId: live
          target: web
